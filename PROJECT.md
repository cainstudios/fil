# Fil Project Definition

Fil CLI expects and `index.js` file in the working directory. This file contains **all the definition** that is required to build the static website or host it dynamically. 

As long as it is properly exposed via `index.js` it is up to you to decide your own file stucture for everything.

If you prefer to use Fil progmatically instead of CLI, you don't also need to name this definition file `index.js`. Please refer to [API docs](/API.md) to see how can you programatically use Fil.

**Please note that ALL functions should BE PURE and should NOT MUTATE input parameters** unless explicitly mentioned otherwise.

Pure function is a function that solely depens on input parameters and always produces the same result UNLESS one of the inputs are changed.

Some fields have `$` in the end of name. `$` means that it is an Observable.

`async` function means that it is a function that returns a Promise.

## Project Definition File (index.js)

This file contains all the definition required to make fil project working. 

```
module.exports = {
  cachePath: () => string,
  contentTypes: () => {id: ContentType},
  contentVersion: async () => string,
  outPath: () => string,
  routeHandlers: () => {id: RouteHandlerType},
  watcher$: (() => Observable<void>) | undefined
}
```
`cachePath` is the path of cache. This path should be readable and writable. The contents of this directiory is controller by fil and this includes removal of everything in this path. Be careful. Cache should not be modified or read directly. Fil manages it.

This has no use when cache is disabled.



`contentTypes` contains all the content types registered to this fil project. Each ContentType has an id, used to cross reference across content types as well as internal accounting. 



`contentVersion` is string that returns a different value when content is changed. This could be any kind of string (i.e. sha-256 hash etc.). The only constraint is that **it should return different value when content is changed**. It is **advised** that it should return the same value when content is the same.

This value is used to determine if cache is still valid. If it doesn't return consistent values for same content, your cache might be invalided for nothing and will yield to worse performance.

This function is called once on application start and end and doesn't necessarrlily need to be fast.

This method doesn't need to be **PURE**.

This has no use when cache is disabled.



`outPath` is the path where output is written. This path should be readable and writable. Fil will not clear this path. It'll overwrite files if necessary.

This has no use in dynamic mode as no output is created.



`routeHandlers` contains all route handlers registered to this fil project. Each RouteHandlerType has an id used for internal accounting.



`watcher$` is an optional function that returns Observable that emits values when sometihg that affects page output happens. The emiitted value doesn't matter or used.

Fil is capabable to auto reload pages once it detects changes on registered `ContentType`s if they are reactive (if they define `contentWatcher$`s and/or `childrenWatcher$`s.). However, occasionally there some external triggers which changes page's output thus better to reload to page, such a detection of a resource fetched purely by frontend AJAX is changed.

This has no use in static mode as there is no page to reload.

## ContentType

Content types can be thought as templates to contents. Each content type defines how to find contents, a way of detecting changes to them, value of the content and their relationships with other contents.

A `ContentType` is an object with the following schema:

```
{
  children: async (({Y} | {id}) => [id]) | undefined,
  childrenArguments: (async ({id}) => {Y}) | undefined,
  childrenWatcher$: (({id}) => Observable<void>) | undefined,
  content: async ({T} | {id} }) => {ANY},
  contentArguments: (async ({id, project}) => {T}) | undefined,
  contentWatcher$: (({id}) => Observable<void>) | undefined
}
```
`children` is an optional async function which recieves either an `id` or values generated by `childrenArguments` of a content of this content type as parameter and returns an array of `id`s which are children of this content. Please see `childrenArguments` function to understand recieved parameters better.

This method doesn't need to be **PURE**. Doing a file system IO, database query, network call or some sort of other data lookup is a natural part of this method. 

Fil already has a caching system built and there is no need to build caching for subsequent queries. 

Children can be in a different `ContentType`. Content structure should be a tree. Children should NOT belong to more than one parent. 

If optional `children` is not provided, Fil will think that this all contents of this `ContentType` has no child at all. In other words, not providing `children` equals to `async () => []`.

Order of children is not important.



`childrenArguments` is an optional async function which recieves an `id` of a content of this content type as parameter returns an object without restrictions on its members. The return value of this function is used as the arguments of `children` function for the content with the same id.

When Fil needs to learn children of a content, first invokes this function with `id` of the content. The value returned by this function is deeply compared with the previous value for the same `id` stored in the cache of Fil.  In case the values match, Fil will consider that there is no changes in children and will not call `children` function. If values doesn't match, Fil will call `children` with the object returned by this function and recalculate and cache children.

It is important that `childrenArguments` is fast, because this will be called many times and directly effects the performance. 

It is expected to return same value from this function, if children are the same. If not, cache will be invalidated for nothing and perfomance will drop.

It is NOT a must to return different value from this function if children change AS LONG AS  a `childrenWatcher$` is implemented. It is a MUST to return different value from this function if no `childrenWatcher$ `for this content type is implemented or changes will not be detected by Fil.

Returned object can contain fields with `Buffer` type for binary data. `Buffer` fields are cached on disk instead of memory and it might slow down system especially in systems without SSDs.

This method doesn't need to be **PURE**. Doing a file system IO, database query, network call or some sort of other data lookup is a natural part of this method. 

If optional `childrenArguments` is not provided, Fil will use `async ({id}) => ({id})` to create arguments to `children` function.



`  childrenWatcher$` is an optional function that recieves an `id` as parameter of this content type and returns an Observable that emits values when children of the content with the provided `id` changes.

This Observable should emit values ONLY when new children are available or children are removed. **Content or children changes of the children** should not trigger an event. If triggered, cache will be invalidated for nothing.

Defining `childrenWatcher$` will enable Fil to undestand lifecycle of children and react to it as it happens. Therefore Fil will be able to auto reload pages when change happends.

This has no use in static mode as there is no page to reload.

If optional `childrenArguments` is not provided, Fil will not be notified of children changes reactively. This will prevent Fil to automatically reload pages. It is also required to have a proper `childrenArguments` when `childrenWatcher$` is not provided.



TODO

  content: async ({T} | {id} }) => {ANY},
  contentArguments: (async ({id, project}) => {T}) | undefined,
  contentWatcher$: (({id}) => Observable<void>) | undefined

## id

`id` is a string that defines a unique address for a content in the system. It has the following structure:

`type@uniqueAddressInThatType`.

`type` is id of one of the `ContentType`s registered to system via `contentTypes` function defined in the Project Definition File.

Type should be defined in the system or Fil will throw an error.

`uniqueAddressInThatType` could be any string, including all sorts of special characters and even emojis. It could be paths, urls or whatsoever. As long as a `ContentType` can understand what this content exacly is via its `id` it could be anything.

Ids that doesn't follow this structure will make Fil throw an error.